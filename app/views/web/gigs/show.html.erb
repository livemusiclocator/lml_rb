<!-- Set back button for Explorer layout navigation -->
<% content_for :show_back_button, true %>

<article class="overflow-scroll min-w-sm max-w-2xl mx-auto pb-4 h-full">
  <% if @gig %>
    <!-- Hero Image Section (conditional) -->
    <% if @gig[:hero_image].present? %>
      <div class="relative max-h-[40svh] overflow-hidden aspect-[2/1] w-full">
        <div class="absolute inset-0 bg-cover bg-center blur-sm" style="background-image: url('<%= @gig[:hero_image] %>')"></div>
        <div class="absolute inset-0 bg-black bg-opacity-40"></div>
        <img src="<%= @gig[:hero_image] %>" class="relative z-10 w-full h-full object-cover" alt="<%= @gig[:name] %> hero image" />
      </div>
    <% end %>

    <!-- Main Header -->
    <header class="flex items-start justify-between flex-row p-4">
      <hgroup class="break-words text-pretty">
        <p class="font-semibold">
          <%= @gig[:start_time]&.strftime("%A, %B %d") %>
        </p>
        <h2 class="flex text-4xl font-bold items-center">
          <!-- Festival Logos -->
          <% if @gig[:series]&.include?('lbmf') %>
            <!-- TODO: LBMF logo needs to be added to assets -->
            <img src="<%= asset_path('lbmf2024logo.png') %>" class="m-2 flex-shrink w-10" alt="LBMF Festival" />
          <% elsif @gig[:series]&.include?('stkildafestival') %>
            <!-- TODO: St Kilda Festival logo needs to be added to assets -->
            <img src="<%= asset_path('skf_blacklogo.svg') %>" class="m-2 flex-shrink w-10" alt="St Kilda Festival" />
          <% end %>
          
          <%= @gig[:name] %>
          
          <!-- Status Indicators -->
          <% if @gig[:status] == "cancelled" %>
            (CANCELLED)
          <% end %>
        </h2>
        <h3 class="font-bold items-center">
          <% if @gig[:ticket_status] == "selling_fast" %>
            <div class="text-xs font-medium rounded-full bg-red-200 p-2 m-2">
              SELLING FAST
            </div>
          <% elsif @gig[:ticket_status] == "sold_out" %>
            <div class="text-xs font-medium rounded-full bg-red-200 p-2 m-2">
              SOLD OUT
            </div>
          <% end %>
        </h3>
      </hgroup>
      
      <!-- TODO: Implement SaveGigButton functionality -->
      <button class="p-2 text-gray-400 hover:text-red-500 transition-colors duration-200" title="Save Gig">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
        </svg>
      </button>
    </header>

    <!-- Aside with all details -->
    <aside class="mx-4 p-4 flex flex-wrap gap-4 justify-start bg-gray-200">
      <!-- DateTime Section -->
      <% if @gig[:start_time].present? %>
        <div class="flex gap-x-2">
          <!-- CalendarIcon -->
          <svg class="w-5 h-5 text-gray-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <ul class="font-semibold text-lg">
            <li aria-label="Date">
              <%= @gig[:start_time]&.strftime("%A, %B %d, %Y") %>
            </li>
            <li aria-label="Time">
              <%= @gig[:start_time]&.strftime("%l:%M %p") %>
              <% if @gig[:end_time].present? %>
                - <%= @gig[:end_time].strftime("%l:%M %p") %>
              <% end %>
            </li>
          </ul>
        </div>
      <% end %>

      <!-- Venue Section -->
      <div class="flex gap-x-2">
        <!-- MapPinIcon -->
        <svg class="w-5 h-5 text-gray-400 mt-1" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
        </svg>
        <ul>
          <li aria-label="Venue" class="font-semibold text-lg">
            <%= @gig.dig(:venue, :name) || @gig[:venue_name] %>
          </li>
          <% venue_address = @gig.dig(:venue, :address) || @gig[:address] %>
          <% if venue_address.present? %>
            <li aria-label="Venue address">
              <%= venue_address %>
            </li>
            <li aria-label="Directions link">
              <%= link_to "Get Directions", 
                  "https://maps.google.com/?q=#{CGI.escape(venue_address)}", 
                  target: "_blank",
                  rel: "noopener noreferrer",
                  class: "inline-flex items-center text-sm text-blue-600 hover:text-blue-800 underline" %>
            </li>
          <% end %>
        </ul>
      </div>

      <!-- Sets Section -->
      <% if @gig[:sets]&.any? %>
        <div class="flex gap-x-2">
          <!-- MusicalNoteIcon -->
          <svg class="w-5 h-5 text-gray-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
          </svg>
          <ul>
            <li class="font-semibold text-lg">Sets</li>
            <% @gig[:sets].each do |set| %>
              <li aria-label="Artist Set">
                <div class="font-medium text-gray-900">
                  <%= set[:artist] || set['artist'] %>
                </div>
                <% start_time = set[:start_time] || set['start_time'] %>
                <% duration = set[:duration] || set['duration'] %>
                <% if start_time.present? || duration.present? %>
                  <div class="text-gray-600 text-sm">
                    <% if start_time.present? %>
                      Start: <%= start_time %>
                    <% end %>
                    <% if duration.present? %>
                      <%= " â€¢ " if start_time.present? %>Duration: <%= duration %>
                    <% end %>
                  </div>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- Prices Section -->
      <% if @gig[:prices]&.any? %>
        <div class="flex gap-x-2">
          <!-- TicketIcon -->
          <svg class="w-5 h-5 text-gray-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
          </svg>
          <ul>
            <li class="font-semibold text-lg">Ticket Information</li>
            <% @gig[:prices].each do |price| %>
              <li aria-label="Ticket Price">
                <span class="text-gray-900 font-medium">$<%= price[:amount] || price['amount'] %></span>
                <span class="text-gray-600"> - <%= price[:description] || price['description'] || price[:type] || price['type'] %></span>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- Info Tags Section -->
      <% if @gig[:info_tags]&.any? %>
        <div class="flex gap-x-2">
          <!-- InformationCircleIcon -->
          <svg class="w-5 h-5 text-gray-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <ul>
            <li class="font-semibold text-lg">Event Information</li>
            <% @gig[:info_tags].each do |tag| %>
              <li aria-label="Event information">
                <%= tag %>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </aside>

    <!-- Description Section -->
    <% if @gig[:description].present? %>
      <section class="px-4 prose">
        <!-- TODO: react-markdown with heading remapping needs implementation -->
        <%= simple_format(@gig[:description]) %>
      </section>
    <% end %>

    <!-- Genres Section -->
    <% if @gig[:genres]&.any? %>
      <section class="flex gap-2 flex-wrap p-4">
        <% @gig[:genres].each do |genre| %>
          <span class="bg-lmlpink text-white text-xs font-medium p-2">
            <%= genre.is_a?(Hash) ? genre[:value] || genre['value'] : genre %>
          </span>
        <% end %>
      </section>
    <% end %>

    <!-- Tickets Section -->
    <% if @gig[:ticket_url].present? %>
      <section class="p-4">
        <%= link_to @gig[:ticket_url], 
            target: "_blank",
            rel: "noopener noreferrer",
            class: "flex content-center transition items-center justify-center text-center px-8 py-4 text-xl font-medium rounded-md shadow-sm text-white bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-200 mx-auto px-8" do %>
          <div class="flex items-center justify-start space-x-1.5">
            <span>Gig Details</span>
          </div>
        <% end %>
      </section>
    <% end %>

  <% else %>
    <div class="flex items-center justify-center min-h-screen">
      <p class="text-gray-500 text-lg">Gig not found</p>
    </div>
  <% end %>
</article>